#!/bin/bash
## #ddev-generated
## Description: One-time initial deployment of local files and DB to remote
## Usage: deploy [env]
## Example: "ddev deploy dev"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

ENV_NAME="${1:-}"

if [ -z "$ENV_NAME" ]; then
    echo -e "${YELLOW}Please select environment to deploy to:${NC}"
    OPTIONS=("dev" "stage" "live")
    select opt in "${OPTIONS[@]}"; do
        case $opt in
            "dev"|"stage"|"live")
                ENV_NAME=$opt
                break
                ;;
            *) echo "Invalid option $REPLY";;
        esac
    done
fi

ENV_FILE=".env.${ENV_NAME}"
ENV_FILE_SECRETS=".env.${ENV_NAME}.local"

if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}Error: Environment config ${ENV_FILE} not found.${NC}"
    exit 1
fi

source "$ENV_FILE"
if [ -f "$ENV_FILE_SECRETS" ]; then source "$ENV_FILE_SECRETS"; fi

echo -e "${CYAN}=======================================================${NC}"
echo -e "${CYAN}      Starting Deployment to Environment: ${YELLOW}${ENV_NAME}${CYAN}      ${NC}"
echo -e "${CYAN}=======================================================${NC}"

echo -e "${RED}WARNING: This will overwrite files and database on the remote server!${NC}"
echo -n "Are you sure you want to proceed? [y/N] "
read -r CONFIRM
if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
fi

# 1. Deploy Database
echo -e "\n${BLUE}>> Phase 1: Database Deployment${NC}"
echo -e "Exporting local database..."
mkdir -p .ddev/.downloads
ddev export-db -f .ddev/.downloads/local_deploy.sql.gz

# Search and replace
DEST_DOMAIN=$(echo "${SOURCE_DOMAINS:-}" | cut -d',' -f1 | xargs)
if [ -z "$DEST_DOMAIN" ]; then
    echo -e "${YELLOW}No source domain configured for replacement. Searching for production domain...${NC}"
    echo -n "Enter the remote domain (e.g. example.com): "
    read -r DEST_DOMAIN
fi

if [ -n "$DEST_DOMAIN" ]; then
    DDEV_HOSTNAME=$(grep "^name:" .ddev/config.yaml | awk '{print $2}' | tr -d '"' | tr -d "'").ddev.site
    echo -e "Replacing ${DDEV_HOSTNAME} with ${DEST_DOMAIN} in dump..."
    gunzip -c .ddev/.downloads/local_deploy.sql.gz | sed "s/${DDEV_HOSTNAME}/${DEST_DOMAIN}/g" | gzip > .ddev/.downloads/local_deploy_replaced.sql.gz
    mv .ddev/.downloads/local_deploy_replaced.sql.gz .ddev/.downloads/local_deploy.sql.gz
fi

echo -e "Uploading and importing to remote..."
rsync -az -e "ssh -p ${SSH_PORT:-22}" .ddev/.downloads/local_deploy.sql.gz "${SSH_USER}@${SSH_HOST}:${SERVER_ROOT}/deploy_db.sql.gz"

ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "bash -s" <<EOF
set -eu -o pipefail
gunzip -c "${SERVER_ROOT}/deploy_db.sql.gz" | mysql -u'${DB_USER}' -h'${DB_HOST}' -p'${DB_PASSWORD}' '${DB_NAME}'
rm "${SERVER_ROOT}/deploy_db.sql.gz"
EOF

echo -e "${GREEN}Database deployment complete!${NC}"

# 2. Deploy Files
echo -e "\n${BLUE}>> Phase 2: Files Deployment${NC}"
DOCROOT=$(grep "^docroot:" .ddev/config.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
LOCAL_ROOT="${DOCROOT:-.}"

echo -e "Pushing files to ${SSH_HOST}:${SERVER_ROOT}${DATA_DIR}..."

# Default ignores + safety ignores for deployment
RSYNC_PUSH_ARGS=("-chavzP" "-e" "ssh -p ${SSH_PORT:-22}")
RSYNC_PUSH_ARGS+=("--exclude=.git" "--exclude=.ddev" "--exclude=node_modules" "--exclude=wp-config.php" "--exclude=wp-config-ddev.php")

DEFAULT_IGNORES="${IGNORED_FILES:-*.pdf,*.zip,*.tar.gz,*.sql,*.sql.gz,*.mp4,*.mov,*.avi,*.log,debug.log}"
IFS=',' read -ra IGNORE_LIST <<< "$DEFAULT_IGNORES"
for item in "${IGNORE_LIST[@]}"; do
    item=$(echo "$item" | xargs)
    if [ -n "$item" ]; then
        RSYNC_PUSH_ARGS+=("--exclude=$item")
    fi
done

rsync "${RSYNC_PUSH_ARGS[@]}" "${LOCAL_ROOT}/" "${SSH_USER}@${SSH_HOST}:${SERVER_ROOT}${DATA_DIR}/"

# 3. Handle Remote wp-config.php
echo -e "\n${BLUE}>> Phase 3: Remote Configuration${NC}"
echo -n "Do you want to patch and upload your local wp-config.php to remote? [y/N] "
read -r GEN_CONFIG
if [[ "$GEN_CONFIG" =~ ^[Yy]$ ]]; then
    echo "Preparing wp-config.php for remote..."
    LOCAL_WPC="${LOCAL_ROOT}/wp-config.php"
    TEMP_WPC=".ddev/.downloads/wp-config.php.remote"
    
    if [ ! -f "$LOCAL_WPC" ]; then
        echo -e "${RED}Error: Local wp-config.php not found at ${LOCAL_WPC}${NC}"
    else
        cp "$LOCAL_WPC" "$TEMP_WPC"
        
        # 3.1 Strip DDEV inclusion block if it still exists
        sed -i "/Include for settings managed by ddev/,/}/d" "$TEMP_WPC"
        
        # 3.2 Swap DDEV values for Remote values
        # We use different delimiters | to avoid issues with URLs containing /
        sed -i "s/define(\s*'DB_NAME'\s*,\s*'db'\s*);/define( 'DB_NAME', '${DB_NAME}' );/" "$TEMP_WPC"
        sed -i "s/define(\s*'DB_USER'\s*,\s*'db'\s*);/define( 'DB_USER', '${DB_USER}' );/" "$TEMP_WPC"
        sed -i "s/define(\s*'DB_PASSWORD'\s*,\s*'db'\s*);/define( 'DB_PASSWORD', '${DB_PASSWORD}' );/" "$TEMP_WPC"
        sed -i "s/define(\s*'DB_HOST'\s*,\s*'db'\s*);/define( 'DB_HOST', '${DB_HOST}' );/" "$TEMP_WPC"
        
        # Site URLs
        PROJECT_URL=$(ddev describe -j | grep -o '"primary_url":"[^"]*"' | cut -d'"' -f4)
        REMOTE_URL=$(echo "https://${DEST_DOMAIN}" | sed 's|/*$||') # Remove trailing slash for consistency
        
        sed -i "s|define(\s*'WP_HOME'\s*,\s*'${PROJECT_URL}'\s*);|define( 'WP_HOME', '${REMOTE_URL}' );|" "$TEMP_WPC"
        sed -i "s|define(\s*'WP_SITEURL'\s*,\s*'${PROJECT_URL}/'\s*);|define( 'WP_SITEURL', '${REMOTE_URL}/' );|" "$TEMP_WPC"

        echo "Uploading patched wp-config.php..."
        rsync -az -e "ssh -p ${SSH_PORT:-22}" "$TEMP_WPC" "${SSH_USER}@${SSH_HOST}:${SERVER_ROOT}${DATA_DIR}/wp-config.php"
        rm "$TEMP_WPC"
        
        echo -e "${GREEN}Remote wp-config.php updated (Salts and custom constants preserved).${NC}"
    fi
fi

echo -e "\n${GREEN}Deployment to ${ENV_NAME} successful!${NC}"
echo -e "${YELLOW}Note: Don't forget to check file permissions on the remote server.${NC}"
