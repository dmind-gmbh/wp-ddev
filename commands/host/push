#!/bin/bash
## #ddev-generated
## Description: One-time initial deployment of local files and DB to remote
## Usage: push [env]
## Example: "ddev push dev"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

ENV_NAME="${1:-}"

if [ -z "$ENV_NAME" ]; then
    echo -e "${YELLOW}Please select environment to push to:${NC}"
    OPTIONS=("dev" "stage" "live")
    select opt in "${OPTIONS[@]}"; do
        case $opt in
            "dev"|"stage"|"live")
                ENV_NAME=$opt
                break
                ;;
            *) echo "Invalid option $REPLY";;
        esac
    done
fi

ENV_FILE=".env.${ENV_NAME}"
ENV_FILE_SECRETS=".env.${ENV_NAME}.local"

if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}Error: Environment config ${ENV_FILE} not found.${NC}"
    exit 1
fi

source "$ENV_FILE"
if [ -f "$ENV_FILE_SECRETS" ]; then source "$ENV_FILE_SECRETS"; fi

echo -e "${CYAN}=======================================================${NC}"
echo -e "${CYAN}      Starting Push to Environment: ${YELLOW}${ENV_NAME}${CYAN}      ${NC}"
echo -e "${CYAN}=======================================================${NC}"

echo -e "${RED}WARNING: This will overwrite files and database on the remote server!${NC}"
echo -n "Are you sure you want to proceed? [y/N] "
read -r CONFIRM
if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
fi

# 1. Push Database
echo -e "\n${BLUE}>> Phase 1: Database Push${NC}"
echo -e "Exporting local database..."
ddev export-db -f .ddev/.downloads/local_push.sql.gz

# Search and replace if SOURCE_DOMAINS is set
if [ -n "${SOURCE_DOMAINS:-}" ]; then
    # Take the first domain as the primary destination domain
    DEST_DOMAIN=$(echo "$SOURCE_DOMAINS" | cut -d',' -f1 | xargs)
    DDEV_HOSTNAME=$(grep "^name:" .ddev/config.yaml | awk '{print $2}' | tr -d '"' | tr -d "'").ddev.site
    
    echo -e "Replacing ${DDEV_HOSTNAME} with ${DEST_DOMAIN}..."
    gunzip -c .ddev/.downloads/local_push.sql.gz | sed "s/${DDEV_HOSTNAME}/${DEST_DOMAIN}/g" | gzip > .ddev/.downloads/local_push_replaced.sql.gz
    mv .ddev/.downloads/local_push_replaced.sql.gz .ddev/.downloads/local_push.sql.gz
fi

echo -e "Uploading and importing to remote..."
# We upload the compressed SQL and then import it on the remote
rsync -az -e "ssh -p ${SSH_PORT:-22}" .ddev/.downloads/local_push.sql.gz "${SSH_USER}@${SSH_HOST}:${SERVER_ROOT}/push_db.sql.gz"

ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" "bash -s" <<EOF
set -eu -o pipefail
gunzip -c "${SERVER_ROOT}/push_db.sql.gz" | mysql -u'${DB_USER}' -h'${DB_HOST}' -p'${DB_PASSWORD}' '${DB_NAME}'
rm "${SERVER_ROOT}/push_db.sql.gz"
EOF

echo -e "${GREEN}Database push complete!${NC}"

# 2. Push Files
echo -e "\n${BLUE}>> Phase 2: Files Push${NC}"
DOCROOT=$(grep "^docroot:" .ddev/config.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
LOCAL_ROOT="${DOCROOT:-.}"

echo -e "Pushing files to ${SSH_HOST}:${SERVER_ROOT}${DATA_DIR}..."

# Default ignores
DEFAULT_IGNORES="${IGNORED_FILES:-*.pdf,*.zip,*.tar.gz,*.sql,*.sql.gz,*.mp4,*.mov,*.avi,*.log,debug.log}"
EXCLUDE_FLAGS="--exclude '.git' --exclude '.ddev' --exclude 'node_modules'"
IFS=',' read -ra IGNORE_LIST <<< "$DEFAULT_IGNORES"
for item in "${IGNORE_LIST[@]}"; do
    item=$(echo "$item" | xargs)
    if [ -n "$item" ]; then
        EXCLUDE_FLAGS="$EXCLUDE_FLAGS --exclude '$item'"
    done
done

# We use -R to ensure relative paths are preserved if needed, but usually we just sync the content of docroot
eval rsync -chavzP -e \"ssh -p ${SSH_PORT:-22}\" $EXCLUDE_FLAGS "${LOCAL_ROOT}/" "${SSH_USER}@${SSH_HOST}:${SERVER_ROOT}${DATA_DIR}/"

echo -e "${GREEN}Files push complete!${NC}"
echo -e "\n${GREEN}Push to ${ENV_NAME} successful!${NC}"
