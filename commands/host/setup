#!/bin/bash
## #ddev-generated
## Description: Setup DDEV project environment, deployment, and WordPress installation
## Usage: setup
## Example: "ddev setup"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo -e "${CYAN}=======================================================${NC}"
echo -e "${CYAN}           DDEV Project Setup Wizard                   ${NC}"
echo -e "${CYAN}=======================================================${NC}"

# 0. Gitignore Setup
echo -e "\n${BLUE}>> Step 0: Gitignore Setup${NC}"
if [ -f ".ddev/scripts/gitignore_wizard.sh" ]; then
    bash .ddev/scripts/gitignore_wizard.sh
else
    echo -e "${YELLOW}Warning: Gitignore wizard script not found.${NC}"
fi

# 1. WordPress Installation
echo -e "\n${BLUE}>> Step 1: WordPress Installation${NC}"
echo -n "Do you want to initialize a fresh WordPress installation? [y/N] " > /dev/tty
read -r INSTALL_WP < /dev/tty
INSTALL_WP=${INSTALL_WP:-N}

if [[ "$INSTALL_WP" =~ ^[Yy]$ ]]; then
    echo -e "${GREEN}Preparing WordPress installation...${NC}"
    
    # 1.1 Update Config for WordPress
    echo "Configuring .ddev/config.yaml for WordPress..."
    sed -i 's/^type:.*$/type: wordpress/' .ddev/config.yaml
    
    # Check if upload_dirs is already set
    if ! grep -q "^upload_dirs:" .ddev/config.yaml; then
        echo 'upload_dirs: ["dummy_uploads"]' >> .ddev/config.yaml
        echo "Set upload_dirs to dummy_uploads to protect real uploads."
    else
        echo "upload_dirs already configured."
    fi
    
    # 1.2 Restart DDEV
    echo "Restarting DDEV to apply changes..."
    ddev restart
    
    # 1.3 Download and Install WordPress
    # Detect Docroot for correct path
    DOCROOT=$(grep "^docroot:" .ddev/config.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
    if [ -n "$DOCROOT" ] && [ "$DOCROOT" != "." ]; then
        WP_PATH_ARGS="--path=/var/www/html/$DOCROOT"
        DOCROOT="${DOCROOT}/" # Normalize for theme setup
    else
        WP_PATH_ARGS=""
        DOCROOT=""
    fi

    echo "Downloading WordPress Core..."
    if [ -n "$WP_PATH_ARGS" ]; then
        ddev wp core download "$WP_PATH_ARGS" --force
    else
        ddev wp core download --force
    fi

    echo -e "${YELLOW}Please enter WordPress Site Title:${NC}" > /dev/tty
    echo -n "Title: " > /dev/tty
    read -r WP_TITLE < /dev/tty
    
    echo -e "${YELLOW}Please enter Admin Username:${NC}" > /dev/tty
    echo -n "Username: " > /dev/tty
    read -r WP_USER < /dev/tty
    
    echo -e "${YELLOW}Please enter Admin Password:${NC}" > /dev/tty
    echo -n "Password: " > /dev/tty
    read -r -s WP_PASS < /dev/tty
    echo "" > /dev/tty
    
    echo -e "${YELLOW}Please enter Admin Email:${NC}" > /dev/tty
    echo -n "Email: " > /dev/tty
    read -r WP_EMAIL < /dev/tty
    
    PROJECT_URL=$(ddev describe -j | grep -o '"primary_url":"[^"]*"' | cut -d'"' -f4)
    
    echo "Installing WordPress..."
    INSTALL_ARGS=("--url=$PROJECT_URL" "--title='$WP_TITLE'" "--admin_user=$WP_USER" "--admin_password=$WP_PASS" "--admin_email=$WP_EMAIL")
    if [ -n "$WP_PATH_ARGS" ]; then
        ddev wp core install "$WP_PATH_ARGS" "${INSTALL_ARGS[@]}"
    else
        ddev wp core install "${INSTALL_ARGS[@]}"
    fi
    
    # 1.4 Optional: Theme Setup
    echo ""
    echo -n "Do you want to download the d-mind Master-Theme? [Y/n] " > /dev/tty
    read -r INSTALL_THEME < /dev/tty
    INSTALL_THEME=${INSTALL_THEME:-Y}
    
    if [[ "$INSTALL_THEME" =~ ^[Yy]$ ]]; then
         # Theme Installation Logic
         THEMES_DIR="${DOCROOT}wp-content/themes"
         TARGET_DIR="${THEMES_DIR}/dmind-wp-master"
         
         mkdir -p "$THEMES_DIR"
         if [ ! -d "$TARGET_DIR" ]; then
             git clone https://github.com/dmind-gmbh/dmind-wp-master.git "$TARGET_DIR"
             echo "Theme installed."
             ddev wp theme activate dmind-wp-master
         else
             echo "Theme directory already exists."
         fi
    fi

    # 1.5 Plugin Setup
    echo ""
    echo -e "${BLUE}>> Step 1.5: Plugin Setup${NC}"
    echo -n "Do you want to install default plugins (ACF Pro, dmind-fse-blocks)? [Y/n] " > /dev/tty
    read -r INSTALL_PLUGINS < /dev/tty
    INSTALL_PLUGINS=${INSTALL_PLUGINS:-Y}

    if [[ "$INSTALL_PLUGINS" =~ ^[Yy]$ ]]; then
        # 1.5.1 ACF Pro
        echo -e "${YELLOW}ACF Pro Installation:${NC}" > /dev/tty
        if [ -f ".env.local" ]; then source ".env.local"; fi
        
        if [ -z "${ACF_PRO_KEY:-}" ]; then
            echo -n "Enter ACF Pro License Key (leave empty to skip): " > /dev/tty
            read -r ACF_KEY < /dev/tty
            if [ -n "$ACF_KEY" ]; then
                echo "ACF_PRO_KEY=\"$ACF_KEY\"" >> .env.local
                ACF_PRO_KEY="$ACF_KEY"
            fi
        fi

        if [ -n "${ACF_PRO_KEY:-}" ]; then
            echo "Installing ACF Pro..."
            # Using the official ACF Pro download URL format
            ACF_URL="https://connect.advancedcustomfields.com/index.php?p=pro&a=download&k=${ACF_PRO_KEY}"
            ddev wp plugin install "$ACF_URL" --activate
        else
            echo "Skipping ACF Pro (no key)."
        fi

        # 1.5.2 dmind-fse-blocks
        echo "Installing dmind-fse-blocks..."
        # Assuming it's a public or accessible git repo, or a zip
        # User feedback mentioned it, I'll assume it's a specific repo
        PLUGIN_DIR="${DOCROOT}wp-content/plugins/dmind-fse-blocks"
        if [ ! -d "$PLUGIN_DIR" ]; then
            git clone https://github.com/dmind-gmbh/dmind-fse-blocks.git "$PLUGIN_DIR"
            ddev wp plugin activate dmind-fse-blocks
        else
            echo "dmind-fse-blocks already exists."
        fi
    fi
    
    echo -e "${GREEN}WordPress installation and plugin setup complete!${NC}"
else
    echo "Skipping WordPress installation."
fi

# 2. Remote Server Setup
echo -e "\n${BLUE}>> Step 2: Remote Server Setup${NC}"
echo -n "Do you want to add a remote server configuration (e.g. dev system)? [Y/n] " > /dev/tty
read -r ADD_SERVER < /dev/tty
ADD_SERVER=${ADD_SERVER:-Y}

if [[ "$ADD_SERVER" =~ ^[Yy]$ ]]; then
    echo "Select environment to configure:"
    OPTIONS=("dev" "stage" "live")
    select opt in "${OPTIONS[@]}"; do
        case $opt in
            "dev"|"stage"|"live")
                ENV_NAME=$opt
                break
                ;;
            *) echo "Invalid option $REPLY";;
        esac
    done

    echo -e "\n${BLUE}Configuring environment: ${ENV_NAME}${NC}"
    if [ -f ".ddev/providers/ensure_env_config.sh" ]; then
        bash .ddev/providers/ensure_env_config.sh "$ENV_NAME"
    else
        echo -e "${YELLOW}Warning: Config helper script not found. Skipping config check.${NC}"
    fi
else
    echo "Skipping remote server setup."
fi

# 3. GitHub Deployment
echo -e "\n${BLUE}>> Step 3: GitHub Deployment${NC}"
if [ -f ".ddev/scripts/deploy_wizard.sh" ]; then
    bash .ddev/scripts/deploy_wizard.sh
else
    echo -e "${YELLOW}Warning: Deployment wizard script not found.${NC}"
fi

echo -e "\n${GREEN}Setup Complete!${NC}"
if [[ "$ADD_SERVER" =~ ^[Yy]$ ]]; then
    echo "You can now run 'ddev pull ${ENV_NAME}' to sync content."
fi
