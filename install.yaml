name: interactive-ssh-pull
version: v1.1.0
project_files:
  - commands/host/setup
  - commands/host/deploy
  - providers/dev.yaml
  - providers/stage.yaml
  - providers/live.yaml
  - providers/pull_script.sh
  - providers/ensure_env_config.sh
  - scripts/gitignore_wizard.sh
  - scripts/deploy_wizard.sh
  - templates/gitignore.template
  - templates/deploy.yml.template

pre_install_actions:
  - |
    #!/bin/bash
    # Migration Script for Legacy DDEV Providers
    
    migrate_env() {
        local env_name="$1"
        local dest_file=".env.${env_name}"
        shift
        local sources=($@)
        for src in "${sources[@]}"; do
            local src_path=".ddev/providers/${src}"
            if [ -f "$src_path" ]; then
                if grep -q "environment_variables:" "$src_path"; then
                    echo "Found legacy configuration in ${src_path}. Migrating to ${dest_file}..."
                    touch "$dest_file"
                    extract_save() {
                        local old_key="$1"
                        local new_key="$2"
                        local val=$(grep "^    *${old_key}:" "$src_path" | head -n1 | awk -F: '{print $2}' | tr -d ' "')
                        if [ -n "$val" ]; then
                            if ! grep -q "^${new_key}=" "$dest_file"; then
                                echo "${new_key}=\"${val}\"" >> "$dest_file"
                            fi
                        fi
                    }
                    extract_save "sshuser" "SSH_USER"
                    extract_save "sshhost" "SSH_HOST"
                    extract_save "serverroot" "SERVER_ROOT"
                    extract_save "datadir" "DATA_DIR"
                    extract_save "dbname" "DB_NAME"
                    extract_save "dbhost" "DB_HOST"
                    extract_save "dbuser" "DB_USER"
                    local edit=$(grep "^    *editconf:" "$src_path" | head -n1 | awk -F: '{print $2}' | tr -d ' "')
                    if [[ "$edit" =~ ^[Nn] ]]; then
                         if ! grep -q "^EDIT_CONFIG=" "$dest_file"; then echo "EDIT_CONFIG=\"n\"" >> "$dest_file"; fi
                    elif [[ "$edit" =~ ^[Yy] ]]; then
                         if ! grep -q "^EDIT_CONFIG=" "$dest_file"; then echo "EDIT_CONFIG=\"y\"" >> "$dest_file"; fi
                    fi
                    return
                fi
            fi
        done
    }
    migrate_env "dev" "dev.yaml" "development.yaml" "old.yaml"
    migrate_env "stage" "stage.yaml" "staging.yaml" "preview.yaml"
    migrate_env "live" "live.yaml" "prod.yaml" "production.yaml"

post_install_actions:
  - |
    # Disable DDEV automatic settings management for WordPress
    if grep -q "disable_settings_management: false" .ddev/config.yaml; then
        sed -i "s/disable_settings_management: false/disable_settings_management: true/" .ddev/config.yaml
    elif ! grep -q "disable_settings_management: true" .ddev/config.yaml; then
        echo "disable_settings_management: true" >> .ddev/config.yaml
    fi
    echo "DDEV settings management disabled to allow custom wp-config.php handling."